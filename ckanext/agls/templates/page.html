{% ckan_extends %}

 {% set pkg = c.pkg_dict %}

{%- block meta -%}
    <meta name="DCTERMS.Language" scheme="RFC3066" content="en"/>
    <meta name="DCTERMS.Type" scheme="AGLSTERMS.Document" content="dataset"/>
    <meta name="DCTERMS.Creator" scheme="AGLSTERMS.AglsAgent" content="{{ pkg['organization']['title'] }}"/>
    <meta name="DCTERMS.Modified" scheme="DCTERMS.ISO8601" content="{{ pkg['metadata_modified'] }}"/>
    <meta name="DCTERMS.Published" scheme="DCTERMS.ISO8601" content="{{ pkg['metadata_created'] }}"/>
    <meta name="DCTERMS.Source.URI" content="{{ pkg.url }}"/>
    <meta name="DCTERMS.License" content="{{ pkg['license_url'] }}"/>
    <meta name="DCTERMS.Coverage.Temporal" content="{{ pkg.temporal_coverage }}"/>
    <meta name="DCTERMS.Coverage.Spatial" content="{{ pkg.spatial_coverage }}"/>
    <meta name="AGLSTERMS.Jurisdiction" scheme="AGLSTERMS.AglsJuri" content="{{ pkg.jurisdiction }}"/>
    <meta name="DCAT.Theme" scheme="VO" content="{% for x in pkg.groups %}{{ x['title'] }},{% endfor %}"/>
    <meta name="DCTERMS.Identifier"
          content="{{ h.url_for(controller='package',action='read',id=c.pkg_dict['name'], qualified=True) }}"/>
    <meta name="DCTERMS.Title" content="{{ pkg['title'] }}"/>
    <meta name="DCTERMS.Description" scheme="" content="{{ pkg['notes'] }}"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    {{ super() }}
{% endblock %}

{% block scripts %}
    <!--[if lt IE 9]><script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.1/themes/smoothness/jquery-ui.css">
{% resource 'ckanext-agls/styles/agls.css' %}
{% resource 'ckanext-agls/styles/jquery-ui.js' %}
    {{ super() }}
    <style>
        .form-horizontal .controls {
            font-size: 0.8em;
            line-height: 15px;
        }
        .form-horizontal .controls *{
            font-size: 14px;

        }
        .form-horizontal .controls a{
            font-size: 0.8em;
        }
    </style>
    <script>
    function gazSearch(gazURL) {
        var re = new RegExp("submit1=(.*\\d)(&|$)");
        var m = re.exec(gazURL);
        if (m != null) {
            gazID = m[1];
            $.getJSON(ckan.url("/api/2/util/gazetteer/latlon?q=" + gazID), function (data){
                if (data.geojson != undefined) {
                    $('#spatial').val(data.geojson);
                }
            })
        } else {
            var re2 = new RegExp("[a-zA-Z].*\\d");
            var m2 = re2.exec(gazURL);
            if (m2 != null) {
                gazID = m2[0];
                $.getJSON(ckan.url("/api/2/util/gazetteer/latlon?q=" + gazID), function (data) {
                    if (data.geojson != undefined) {
                        $('#spatial').val(data.geojson);
                    }
                })
            }
        }
    }
    function setValueIfOrg(idOrg) {
        $.getJSON(ckan.url("/api/3/action/organization_show?id=" + idOrg), function (data) {
            var orgTitle = data['result']['title'];
            var extras = data['result']['extras'];
            for (var i=0; i < extras.length; i++) {
                if (extras[i].key === 'jurisdiction') {
                    $('#field-jurisdiction').val(extras[i].value);
                } else  if (extras[i].key === 'email') {
                    $('#field-contact_point').val(extras[i].value);
                } 
            }
            $('#field-author').val(orgTitle);
        })
    }
    var prev_handler = window.onload;
    window.onload = function () {
        if (prev_handler) {
            prev_handler();
        }
            $("#field-spatial_coverage").change(function (e) {
                gazURL = e.target.value;
                gazSearch(gazURL);
            });
            gazSearch($("#field-spatial_coverage").val());
            $(function() {
                $( "#field-temporal_coverage_from" ).datepicker();
                $( "#field-temporal_coverage_to" ).datepicker();
            });
            $("#field-organizations").change(function (e) {
                setValueIfOrg(e.target.value);
            });
        };

    </script>

{% endblock %}
